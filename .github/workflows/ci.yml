name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  docs:
    name: Validate Documentation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check markdown syntax
        uses: DavidAnson/markdownlint-cli2-action@v19
        with:
          globs: '**/*.md'
        continue-on-error: true

      - name: Check markdown links
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          use-quiet-mode: 'yes'
        continue-on-error: true

  pmat:
    name: PMAT Quality Gates
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-action@stable

      - name: Install pmat
        run: cargo install pmat --locked

      - name: Run PMAT compliance check
        run: pmat comply check

      - name: Run PMAT quality gates
        run: pmat quality-gate || true

  validate-examples:
    name: Validate Example Code
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-action@stable

      - name: Install apr-cli
        run: cargo install apr-cli --locked
        continue-on-error: true

      - name: Check apr CLI available
        run: apr --version || echo "apr-cli not installed"

  brick-score:
    name: ComputeBrick Profiling
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-action@stable

      - name: Install tools
        run: |
          cargo install apr-cli --locked || true
          cargo install pmat --locked

      - name: Run ComputeBrick profile (tiny tier for CI)
        run: ./brick/profile.sh tiny
        continue-on-error: true

      - name: Calculate brick score
        run: |
          if ls brick/profiles/*.json 1> /dev/null 2>&1; then
            LATEST=$(ls -t brick/profiles/*.json | head -1)
            pmat brick-score --input "$LATEST" --threshold 50 || true
          else
            echo "No profile data available"
          fi

      - name: Upload profile artifacts
        uses: actions/upload-artifact@v4
        with:
          name: brick-profiles
          path: brick/profiles/
          if-no-files-found: ignore
